name: Create or Update Release

on:
  push:
    branches:
      - main 

permissions:
  contents: write
  actions: read

jobs:
  update-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate CLI
        run: echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token

      - name: Find version from .deb file
        id: get_version
        run: |
          FILE=$(ls *.deb | head -n1)  # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π .deb —Ñ–∞–π–ª
          echo "DEB FILE: $FILE"
          VERSION=$(echo "$FILE" | sed -n 's/.*_\([0-9.]\+-[0-9]\+\)\.deb/\1/p')
          echo "VERSION: $VERSION"
          echo "TAG=v$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create or Update GitHub Release
        run: |
          NAME="Release $VERSION"
          BODY="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–ª–∏–∑ $VERSION"

          if gh release view "$TAG" &>/dev/null; then
            echo "üîÑ Release $TAG —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ..."
            gh release edit "$TAG" --title "$NAME" --notes "$BODY"
          else
            echo "üöÄ –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ä–µ–ª–∏–∑ $TAG..."
            gh release create "$TAG" --title "$NAME" --notes "$BODY"
          fi

      - name: Upload .deb packages
        run: |
          for file in *.deb; do
            echo "‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∂–∞–µ–º $file..."
            gh release upload "$TAG" "$file" --clobber
          done

